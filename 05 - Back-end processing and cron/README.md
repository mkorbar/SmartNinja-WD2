# Lesson 05 - Back-end processing and cron

Why: Learn about scheduled jobs that run regularly, outside of a request cycle



## What are cron jobs and how do they work

Cron jobs are commands or scripts that are scheduled to run periodically at fixed times, dates, or intervals. They're usually ran using the cron scheduling utility in Unix-like operating systems. The term "cron" comes from the word "chronos," which means time in Greek.

Here's how cron jobs work:

1. **Cron Tab**: The cron utility uses a configuration file called the "cron tab" to schedule jobs. Each user on a Unix-like system can have their own cron tab, which contains entries specifying commands or scripts to be executed and the schedule at which they should run.
2. **Cron Schedule**: The schedule for a cron job is specified using a cron expression, which consists of five fields representing minute, hour, day of the month, month, and day of the week. Each field can contain a single value, a list of values separated by commas, a range of values, or special characters to represent all possible values.
3. **Execution**: The cron daemon, a background process that runs continuously, checks the cron tab periodically to determine if any scheduled jobs need to be executed. If a job's schedule matches the current time, the cron daemon invokes the specified command or script to run the job.
4. **Output**: The output generated by a cron job, such as error messages or program output, is typically sent via email to the user who owns the cron tab. Alternatively, the output can be redirected to a file.



## Cron unix utiliy

1. **Log into Linux**: Use SSH to connect to your Linux server.
2. **Edit the Cron Tab**: Open the cron tab using the command `crontab -e`.
3. **Add a Cron Job**: Enter the schedule and command/script you want to run. Example:

```
0 0 * * * /path/to/my_script.py
```

4. **Save and Exit**: Save the changes and exit the text editor (e.g., `:wq` in Vi or `Ctrl + O`, `Ctrl + X` in Nano).

5. **Verify**: Check the added cron job with `crontab -l`.

![Cron Jobs](./imgs/cron.jpeg)

## Examples of cron tasks

1. **System Maintenance**:

   Running cleanup scripts to remove temporary files, logs, or outdated cache files on a daily or weekly basis. Regular system maintenance helps keep the server running smoothly by freeing up disk space and optimizing performance.

2. **Data Backups**:

   Scheduling database backups every night at midnight to ensure that critical data is securely stored. Automated backups help prevent data loss in the event of hardware failures, human error, or security breaches.

3. **Scheduled Updates in Web Development**:

   Automatically fetching and updating content from external sources, such as news feeds or social media APIs, every hour. Scheduled updates ensure that web content remains fresh and relevant without manual intervention.

4. **Server Administration**:

   Periodically checking for and applying operating system updates or security patches on a weekly basis. Regularly updating the server's software helps protect against security vulnerabilities and ensures system stability.

Cron jobs provide a reliable and efficient way to automate these routine tasks, reducing the need for manual intervention and freeing up developers' time to focus on more critical aspects of web development and server management.



In web development, we often use cron jobs for tasks that take a long time to finish. When you visit a webpage, it should load quickly, ideally within a second or two. But sometimes, we need to do heavy work on the server that can't be done that fast. In these cases, instead of making you wait, we quickly save the necessary information, show you something on the webpage, and then do the heavy work in the background using a cron job.

Some examples of these tasks are:

- **Generating Reports or Aggregating Data**:
  - **Example**: A sales dashboard application needs to generate daily sales reports.
  - **Implementation**: The application quickly saves daily sales data to a database. Later, a cron job runs nightly to aggregate this data and generate a comprehensive sales report for management to review.
- **Fetching Information from an API**:
  - **Example**: A weather forecast application needs to fetch weather data from a third-party API.
  - **Implementation**: The application quickly saves user requests and responses to a database. Then, a cron job runs periodically to fetch updated weather data from the API and store it in the database for future use.
- **Scraping Web Pages**:
  - **Example**: A price comparison website needs to scrape product prices from various online retailers.
  - **Implementation**: The website quickly saves the URLs of product pages to a database. Later, a cron job runs periodically to visit these URLs, scrape the product prices, and update the database with the latest pricing information.
- **Processing Images, Audio, or Video Files**:
  - **Example**: A social media platform allows users to upload images for profile pictures.
  - **Implementation**: Upon user upload, the platform quickly saves the images to storage. Then, a cron job runs periodically to process these images, such as resizing them to fit various display sizes, and updates the user profiles accordingly.
- **Generating Assets**:
  - **Example**: A web application needs to generate thumbnails for videos uploaded by users.
  - **Implementation**: Upon video upload, the application quickly saves the video files to storage. Later, a cron job runs periodically to generate thumbnails for these videos, improving the user experience when browsing video content.
- **Computational-Intense Operations**:
  - **Example**: A scientific research website needs to perform complex calculations for data analysis.
  - **Implementation**: User requests trigger the submission of data for analysis, which is quickly saved to a queue. A cron job runs in the background, picking up tasks from the queue, performing the calculations, and storing the results for users to access later.





## Create CLI for Flask

In **scheduled.py** file add a new function:

```python
import models
from config import UPLOAD_FOLDER, THUMB_FOLDER

def register_commands(app):

    @app.cli.command("process_imgs")
    def process_imgs():

        users = models.get_all_users()
        for user in users:
            if THUMB_FOLDER not in user.avatar_file:
                print(f'processing user: {user}')
                # here we should actually do the work
            else:
                print(f'skipping user {user}')

```

In **main.py** we have to import the function and call it to register the CLI commands.

```diff
 import hashlib
 import json
 from config import MAX_SECRET
 from blueprints import api
+from scheduled import register_commands
 
 app = Flask(__name__)
 
@@ -17,6 +18,7 @@ with app.app_context():
     db.create_all()
 
 app.register_blueprint(api.api, url_prefix='/api')
+register_commands(app)
 
 """
 a simple (bad) example for generating test users

```

With this we can call the function from the command line:

```bash
flask --app main.py process_images
```

### Add the cropping function

Let's add the functionality for cropping images. This is the working part of the program and it could be anything; image processing, backups, data aggregation ...

The internals of this function are not crucial, but it opens the image, cuts it in the pre-set dimensions and saves it in the different location

```python
from os import path
from PIL import Image

def create_thumbnail(user, app):

    image = Image.open(path.join(app.root_path, UPLOAD_FOLDER, user.avatar_file))
    left = 40
    top = 0
    right = 460
    bottom = 350
    print('cropping ...')
    cropped_img = image.crop((left, top, right, bottom))

    print('saving ...')
    thumbnail_path = path.join(THUMB_FOLDER, user.avatar_file)
    cropped_img.save(path.join(app.root_path, thumbnail_path))

    models.update_user(id=user.id, avatar_file=thumbnail_path)
```

We're using the `app.root_path` so we can run it with Cron.

## Configure Cron

Add a **crontab entry** with crontab -e

```
0 * * * * /home/matej/sn_lesson05_code/.venv/bin/python /home/matej/sn_lesson05_code/.venv/bin/flask --app=/home/matej/sn_lesson05_code/main.py process_imgs > /tmp/sn_cron_log.txt 2>&1
```

When we save the file, the processing of the images will start on the first minute of every hour, every day in the year.

## Homework

- create a script that does the clean-up of the upload folder and run that script with cron
- change the cropping script such that it crops out the face only
  - additionaly it can cut it as a circle
